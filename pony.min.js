(function(e,t){var n=function(e){var t,r;if(!(this instanceof n)){return new n(e)}this.settings=f(e||{});if(this.settings.queueMessages===true){this.messageQueue={}}this.subscriptionList={};this.subscriptionQueue={};this.subscribersTokenIndex={};this.messageSubscriptionTokenIndex={};this.asyncTimeoutIds=[];if(this.settings.clearMessageQueueEvery){this.startClearingMessageQueue()}if(this.settings.messageList){this.messages={};t=this.settings.messageList.length;while(t--){r=this.settings.messageList[t];this.messages[r]=r}}return this},r=0,i=0,s=function(e,n){var i,s=e.instance,o=e.message,u=e.data,a=e.synchronousPublish,f=e.subscribers,l,c=[],h,p=[],d,v,m=0,g=function(e,t){var n;try{n=e.apply(s,t)}catch(r){setTimeout(function(){throw r},0);return}finally{m+=1}if(a){c.push(n)}else if(s.settings&&s.settings.queueMessages===true&&l){l.returnValues.push(n);if(m==f.length&&p.length!==0){for(v=0,d=p.length;v<d;v++){p[v](l.returnValues)}}}},y=false,b;if(n!==t&&Object.prototype.toString.call(n)=="[object Boolean]"&&n==true){y=true;n=null}else if(n!==t&&Object.prototype.toString.call(n)!="[object Function]"){n=null}f=f||s.subscriptionList[o];h=f?f.length:0;if(s.settings.queueMessages===true&&!y){if(!s.messageQueue.hasOwnProperty(o)){s.messageQueue[o]=i=[]}else{i=s.messageQueue[o]}l={id:r++,data:u,subscriptionCount:h,returnValues:[],complete:function(e){p.push(e)}};i.push(l)}if(!f||!h){return false}if(a){while(h--){g(f[h],u);if(n){n()}}}else{while(h--){b=setTimeout(function(e,t){return function(){g(e,t);if(n){n()}}}(f[h],u),0);s.asyncTimeoutIds.push(b)}}if(a){return c}else if(s.settings.queueMessages===true&&l){return l}return true},o=function(e,t){var n=e.subscribersTokenIndex[t],r=e.messageSubscriptionTokenIndex[t],i;i=e.subscriptionList[r].splice(n,1)[0];if(e.subscriptionList[r]===0){delete e.subscriptionList[r]}delete e.subscribersTokenIndex[t];delete e.messageSubscriptionTokenIndex[t];return i},u=function(e,t,n){e.subscribersTokenIndex[i]=e.subscriptionList[t].push(n)-1;e.messageSubscriptionTokenIndex[i]=t;return i},a={queueMessages:true,clearMessageQueueEvery:360,messageList:null},f=function(e){var t;for(t in a){if(!(t in e)){e[t]=a[t]}}return e},l=function(e,n){if(n===t||e.messages&&!(n in e.messages)){throw Error("Message "+n+" not accepted by this Pony instance. List of available messages: "+e.settings.messageList)}};n.prototype={constructor:n,subscribe:function(e){var t=Array.prototype.slice.call(arguments).slice(1),n=[],r,o,a,f;l(this,e);if(!this.subscriptionList.hasOwnProperty(e)){this.subscriptionList[e]=[]}if(this.settings.queueMessages===true&&this.messageQueue[e]&&this.messageQueue[e].length){f=this.messageQueue[e].length;while(f--){s({instance:this,message:e,data:this.messageQueue[e][f].data,synchronousPublish:false,subscribers:t},true)}}if(t.length>1){for(r=0,o=t.length;r<o;r++){n.push(u(this,e,t[r]));i+=1}return n}else{a=u(this,e,t[0]);i+=1;return a}},unsubscribe:function(e){var t,n;if(!e){return}if(!e.length){n=o(this,e)}else{t=e.length;n=[];while(t--){n.push(o(this,e[t]))}}return n},publish:function(e){var t=Array.prototype.slice.call(arguments).slice(1);l(this,e);return s({instance:this,message:e,data:t,synchronousPublish:false})},publishSync:function(e){var t=Array.prototype.slice.call(arguments).slice(1);l(this,e);return s({instance:this,message:e,data:t,synchronousPublish:true})},startClearingMessageQueue:function(){var e=this;if(!this.clearMessageQueueInterval&&this.settings.clearMessageQueueEvery&&this.settings.queueMessages){e.clearMessageQueueInterval=setInterval(function(){e.clearMessageQueue()},this.settings.clearMessageQueueEvery*1e3)}return this},stopClearingMessageQueue:function(){if(this.clearMessageQueueInterval){clearInterval(this.clearMessageQueueInterval);this.clearMessageQueueInterval=null}return this},clearMessageQueue:function(){this.messageQueue={};return this},destroy:function(){var e,t=this.asyncTimeoutIds.length;while(t--){clearTimeout(this.asyncTimeoutIds[t])}for(e in this){if(this.hasOwnProperty(e)){delete this[e]}}}};e.Pony=n;e.pony=n()})(this);