;(function(context,undefined){var
    Pony=function(settings){var
        instance=this;if(!(this instanceof Pony)){return new Pony(settings);}
        this.settings=mergeWithDefaultSettings(settings||{});if(this.settings.queueMessages===true){this.messageQueue={};}
        this.subscriptionList={};this.subscriptionQueue={};this.subscribersTokenIndex={};this.messageSubscriptionTokenIndex={};if(this.settings.clearMessageQueueEvery){this.startClearingMessageQueue();}
        return this;},messageQueueObjectId=0,subscriptionToken=0,publish=function(kwargs,cb){var
        messageQueue,instance=kwargs.instance,message=kwargs.message,data=kwargs.data,synchronousPublish=kwargs.synchronousPublish,subscribers=kwargs.subscribers,publicationObject,returnValues=[],subscribersLen,callbackQueue=[],len,i,deliveredMessageCount=0,deliverMessage=function(subscriber,data){var
            returnValue;try{returnValue=subscriber.apply(context,data);}catch(e){setTimeout(function(){throw e;},0);return;}finally{deliveredMessageCount+=1;}
            if(synchronousPublish){returnValues.push(returnValue);}else if(instance.settings.queueMessages===true&&publicationObject){publicationObject.returnValues.push(returnValue);if(deliveredMessageCount==subscribers.length&&callbackQueue.length!==0){for(i=0,len=callbackQueue.length;i<len;i++){callbackQueue[i](publicationObject.returnValues);}}}},avoidAddingToMessageQeue=false;if(cb!==undefined&&toString.call(cb)=="[object Boolean]"&&cb==true){avoidAddingToMessageQeue=true;cb=null;}else if(cb!==undefined&&toString.call(cb)!="[object Function]"){cb=null;}
        subscribers=subscribers||instance.subscriptionList[message];subscribersLen=subscribers?subscribers.length:0;if(instance.settings.queueMessages===true&&!avoidAddingToMessageQeue){if(!instance.messageQueue.hasOwnProperty(message)){instance.messageQueue[message]=messageQueue=[];}else{messageQueue=instance.messageQueue[message];}
            publicationObject={id:messageQueueObjectId++,data:data,subscriptionCount:subscribersLen,returnValues:[],complete:function(fn){callbackQueue.push(fn);}};messageQueue.push(publicationObject);}
        if(!subscribers||!subscribersLen){return false;}
        if(synchronousPublish){while(subscribersLen--){deliverMessage(subscribers[subscribersLen],data);if(cb){cb();}}}else{while(subscribersLen--){setTimeout((function(subscriber,data){return function(){deliverMessage(subscriber,data);if(cb){cb();}};})(subscribers[subscribersLen],data),0);}}
        if(synchronousPublish){return returnValues;}else if(instance.settings.queueMessages===true&&publicationObject){return publicationObject;}
        return true;},unsubscribeTokenFromInstance=function(instance,subscriptionToken){var
        tokenIndex=instance.subscribersTokenIndex[subscriptionToken],message=instance.messageSubscriptionTokenIndex[subscriptionToken],unsubscribedSubscriber;unsubscribedSubscriber=instance.subscriptionList[message].splice(tokenIndex,1)[0]
        if(instance.subscriptionList[message]===0){delete instance.subscriptionList[message];}
        delete instance.subscribersTokenIndex[subscriptionToken];delete instance.messageSubscriptionTokenIndex[subscriptionToken];return unsubscribedSubscriber;},addSubscriberToInstance=function(instance,message,subscriber){instance.subscribersTokenIndex[subscriptionToken]=instance.subscriptionList[message].push(subscriber)-1;instance.messageSubscriptionTokenIndex[subscriptionToken]=message;return subscriptionToken;},defaultSettings={queueMessages:true,clearMessageQueueEvery:360},mergeWithDefaultSettings=function(settings){var
        key;for(key in defaultSettings){if(!(key in settings)){settings[key]=defaultSettings[key];}}
        return settings;};Pony.prototype={constructor:Pony,subscribe:function(message){var
    subscribers=Array.prototype.slice.call(arguments).slice(1),subscriptionTokenList=[],i,subscribersLen,pony=this,returnSubscriptionToken,messageQueueLen;if(!this.subscriptionList.hasOwnProperty(message)){this.subscriptionList[message]=[];}
    console.log("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",message,this.messageQueue);if(this.settings.queueMessages===true&&this.messageQueue[message]&&this.messageQueue[message].length){messageQueueLen=this.messageQueue[message].length;while(messageQueueLen--){publish({instance:this,message:message,data:this.messageQueue[message][messageQueueLen].data,synchronousPublish:false,subscribers:subscribers},true);}}
    if(subscribers.length>1){for(i=0,subscribersLen=subscribers.length;i<subscribersLen;i++){subscriptionTokenList.push(addSubscriberToInstance(this,message,subscribers[i]));subscriptionToken+=1;}
        return subscriptionTokenList;}else{returnSubscriptionToken=addSubscriberToInstance(this,message,subscribers[0]);subscriptionToken+=1;return returnSubscriptionToken;}},unsubscribe:function(subscriptionToken){var
    subscriptionTokenLen,unsubscribedCallbacks;if(!subscriptionToken.length){unsubscribedCallbacks=unsubscribeTokenFromInstance(this,subscriptionToken);}else{subscriptionTokenLen=subscriptionToken.length;unsubscribedCallbacks=[];while(subscriptionTokenLen--){unsubscribedCallbacks.push(unsubscribeTokenFromInstance(this,subscriptionToken[subscriptionTokenLen]));}}
    return unsubscribedCallbacks;},publish:function(message){var
    data=Array.prototype.slice.call(arguments).slice(1);console.log("ccccccccccccccccccccccccccccccccccccccc",message,this.messageQueue);return publish({instance:this,message:message,data:data,synchronousPublish:false});},publishSync:function(message){var
    data=Array.prototype.slice.call(arguments).slice(1);return publish({instance:this,message:message,data:data,synchronousPublish:true});},startClearingMessageQueue:function(){var
    instance=this;if(!this.clearMessageQueueInterval&&this.settings.clearMessageQueueEvery&&this.settings.queueMessages){instance.clearMessageQueueInterval=setInterval(function(){instance.clearMessageQueue();},this.settings.clearMessageQueueEvery*1000);}
    return this;},stopClearingMessageQueue:function(){if(this.clearMessageQueueInterval){clearInterval(this.clearMessageQueueInterval);this.clearMessageQueueInterval=null;}
    return this;},clearMessageQueue:function(){this.messageQueue={};return this;}};context.Pony=Pony;context.pony=Pony();})(this);